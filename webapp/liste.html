<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung aufgeben</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="liste-body">
    <div class="container">
        <div class="deadline-display" id="deadlineDisplay" style="display: none;"></div>
        <div class="page-wrapper">
            <main class="main-content">
                <form id="orderForm">
                    <div class="menu-wrapper">
                        <div class="category-card">
                            <div class="category-header"><h2 class="category-title">Speisen</h2></div>
                            <div class="controls-wrapper">
                                <input type="search" class="search-input" data-controls="speisen-list" placeholder="Speisen durchsuchen...">
                                <div class="sort-dropdown-wrapper">
                                    <button type="button" class="sort-button" data-controls="speisen-sort-menu">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25" /></svg>
                                        <span>Sortieren</span>
                                    </button>
                                    <div class="sort-dropdown-menu" id="speisen-sort-menu">
                                        <a href="#" class="sort-option selected" data-value="default">Standard</a>
                                        <a href="#" class="sort-option" data-value="price-asc">Preis aufsteigend</a>
                                        <a href="#" class="sort-option" data-value="price-desc">Preis absteigend</a>
                                    </div>
                                </div>
                            </div>
                            <div class="items-list" id="speisen-list"></div>
                        </div>
                        <div class="category-card">
                            <div class="category-header"><h2 class="category-title">Getränke</h2></div>
                            <div class="controls-wrapper">
                                <input type="search" class="search-input" data-controls="getraenke-list" placeholder="Getränke durchsuchen...">
                                <div class="sort-dropdown-wrapper">
                                    <button type="button" class="sort-button" data-controls="getraenke-sort-menu">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25" /></svg>
                                        <span>Sortieren</span>
                                    </button>
                                    <div class="sort-dropdown-menu" id="getraenke-sort-menu">
                                        <a href="#" class="sort-option selected" data-value="default">Standard</a>
                                        <a href="#" class="sort-option" data-value="price-asc">Preis aufsteigend</a>
                                        <a href="#" class="sort-option" data-value="price-desc">Preis absteigend</a>
                                    </div>
                                </div>
                            </div>
                            <div class="items-list" id="getraenke-list"></div>
                        </div>
                    </div>
                    <div class="submission-card">
                        <h3 id="form-title">Deine Bestellung abschließen</h3>
                        <input type="text" id="creatorName" placeholder="Dein Name" required>
                        <div class="total-price">Gesamt: <span id="totalPriceSpan">0,00 €</span></div>
                        <button type="submit" class="btn" id="submit-button">Bestellung abschicken</button>
                        <p id="formError" style="color:red;display:none;margin-top:10px;">Bitte lege mindestens eine Speise in den Warenkorb und gib deinen Namen ein.</p>
                    </div>
                </form>
            </main>
            <aside class="sidebar">
                <div class="liquid-card">
                    <h3 class="liquid-header">Warenkorb</h3>
                    <div class="items-list" id="cart-list">
                        <p id="cart-placeholder">Dein Warenkorb ist leer.</p>
                    </div>
                </div>
                <div class="liquid-card" style="margin-top: 30px;">
                    <h3 class="liquid-header">Zuletzt bestellt</h3>
                    <div class="items-list" id="history-list">
                        <p id="history-placeholder">Hier erscheinen deine letzten Bestellungen.</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const speisenList = document.getElementById('speisen-list');
        const getraenkeList = document.getElementById('getraenke-list');
        const cartList = document.getElementById('cart-list');
        const historyList = document.getElementById('history-list');
        const cartPlaceholder = document.getElementById('cart-placeholder');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const orderForm = document.getElementById('orderForm');
        const totalPriceSpan = document.getElementById('totalPriceSpan');
        const creatorNameInput = document.getElementById('creatorName');
        const formError = document.getElementById('formError');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const deadlineDisplay = document.getElementById('deadlineDisplay');
        const apiUrl = 'http://localhost:8080/api/items';
        const params = new URLSearchParams(window.location.search);
        const listId = params.get('id');
        const orderIdToEdit = params.get('edit');
        const itemDataMap = new Map();
        let allSpeisen = [], allGetraenke = [];
        let speisenSortValue = 'default', getraenkeSortValue = 'default';
        let cart = [];
        let selectedDrink = null;

        function disableForm(message) {
            orderForm.querySelectorAll('button, input').forEach(el => el.disabled = true);
            document.querySelectorAll('.search-input, .sort-button').forEach(el => el.disabled = true);
            submitButton.textContent = message;
            formTitle.textContent = "Bestellungen geschlossen";
        }

        function loadAndCheckDeadline() {
            if (!listId) return;
            fetch(`http://localhost:8080/api/lists/${listId}`)
                .then(res => res.json())
                .then(listData => {
                    if (listData.deadline) {
                        const deadline = new Date(listData.deadline);
                        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                        deadlineDisplay.textContent = `Bestellungen möglich bis: ${deadline.toLocaleString('de-DE', options)} Uhr`;
                        deadlineDisplay.style.display = 'block';
                        if (new Date() > deadline) {
                            deadlineDisplay.textContent += " (Frist abgelaufen)";
                            deadlineDisplay.classList.add('expired');
                            disableForm("Bestellfrist abgelaufen");
                        }
                    }
                });
        }

        function setupSortDropdowns() {
            document.querySelectorAll('.sort-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menuId = button.dataset.controls;
                    const menu = document.getElementById(menuId);
                    const isActive = menu.classList.contains('active');
                    document.querySelectorAll('.sort-dropdown-menu.active').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.sort-button.active').forEach(b => b.classList.remove('active'));
                    if (!isActive) {
                       menu.classList.add('active');
                       button.classList.add('active');
                    }
                });
            });
            document.querySelectorAll('.sort-dropdown-wrapper').forEach(wrapper => {
                wrapper.addEventListener('click', e => e.stopPropagation());
            });
            document.querySelectorAll('.sort-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const menu = option.closest('.sort-dropdown-menu');
                    const targetListId = menu.id.includes('speisen') ? 'speisen-list' : 'getraenke-list';
                    if (targetListId === 'speisen-list') speisenSortValue = option.dataset.value;
                    else getraenkeSortValue = option.dataset.value;
                    menu.querySelectorAll('.sort-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    menu.classList.remove('active');
                    menu.previousElementSibling.classList.remove('active');
                    renderItems();
                });
            });
            window.addEventListener('click', () => {
                document.querySelectorAll('.sort-dropdown-menu.active').forEach(menu => menu.classList.remove('active'));
                document.querySelectorAll('.sort-button.active').forEach(btn => btn.classList.remove('active'));
            });
        }

        function renderItems() {
            const speisenSearchTerm = document.querySelector('input[data-controls="speisen-list"]').value.toLowerCase().trim();
            const getraenkeSearchTerm = document.querySelector('input[data-controls="getraenke-list"]').value.toLowerCase().trim();
            const processList = (itemList, searchTerm, sortValue) => {
                let processedItems = itemList.filter(item => 
                    (item.title || item.name).toLowerCase().includes(searchTerm) || 
                    (item.description || '').toLowerCase().includes(searchTerm)
                );
                if (sortValue === 'price-asc') processedItems.sort((a, b) => parsePrice(a.price) - parsePrice(b.price));
                else if (sortValue === 'price-desc') processedItems.sort((a, b) => parsePrice(b.price) - parsePrice(a.price));
                return processedItems;
            };
            speisenList.innerHTML = '';
            getraenkeList.innerHTML = '';
            processList(allSpeisen, speisenSearchTerm, speisenSortValue).forEach(item => speisenList.appendChild(createItemButton(item)));
            processList(allGetraenke, getraenkeSearchTerm, getraenkeSortValue).forEach(item => getraenkeList.appendChild(createItemButton(item)));
            setupScrollAnimations(speisenList);
            setupScrollAnimations(getraenkeList);
            updateMenuSelection();
        }
        
        function parsePrice(priceValue) {
            if (typeof priceValue === 'number') return priceValue;
            if (typeof priceValue !== 'string') return 0;
            const cleanedString = priceValue.replace(/[^0-9,-]/g, '').replace(',', '.').trim();
            const price = parseFloat(cleanedString);
            return isNaN(price) ? 0 : price;
        }

        const formatPrice = (price) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(price);
        
        function updateMenuSelection() {
            document.querySelectorAll('#speisen-list .item-button').forEach(btn => {
                const isInCart = cart.some(cartItem => cartItem.id === btn.dataset.id);
                btn.classList.toggle('in-cart', isInCart);
            });
            document.querySelectorAll('#getraenke-list .item-button').forEach(btn => {
                const isSelected = selectedDrink && selectedDrink.name === btn.dataset.id;
                btn.classList.toggle('selected', isSelected);
            });
        }

        function renderCart() {
            cartList.innerHTML = '';
            cartPlaceholder.style.display = cart.length === 0 && !selectedDrink ? 'block' : 'none';
            cart.forEach((item, index) => {
                const itemDetails = itemDataMap.get(item.id);
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `<div class="cart-item-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M19.5,8.5c-0.2-1-1-1.8-2-1.8H6.4c-1,0-1.8,0.8-2,1.8L3.6,13.2C3.2,15.4,4.9,18,7.2,18h9.6c2.3,0,4.1-2.6,3.7-4.8L19.5,8.5z M7,20c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S8.1,20,7,20z M17,20c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S18.1,20,17,20z"/></svg></div><div class="cart-item-info"><div class="food-name">${itemDetails.title}</div></div><button type="button" class="cart-item-remove" data-cart-index="${index}">×</button>`;
                cartList.appendChild(cartItem);
            });
            if (selectedDrink) {
                const drinkDetails = itemDataMap.get(selectedDrink.name);
                const drinkItem = document.createElement('div');
                drinkItem.className = 'cart-item';
                drinkItem.innerHTML = `<div class="cart-item-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M7.5,16c-1.4,0-2.5,1.1-2.5,2.5S6.1,21,7.5,21s2.5-1.1,2.5-2.5S8.9,16,7.5,16z M16.5,16c-1.4,0-2.5,1.1-2.5,2.5 s1.1,2.5,2.5,2.5s2.5-1.1,2.5-2.5S17.9,16,16.5,16z M20,4H4L3,2H0v2h2l3.6,7.6L5.2,14c-0.1,0.3,0,0.5,0.2,0.7 c0.2,0.2,0.5,0.3,0.7,0.3h10.3v-2H6.2l0.9-2H17l4-7L20,4z"/></svg></div><div class="cart-item-info"><div class="food-name">${drinkDetails.name}</div></div><button type="button" class="cart-item-remove" data-drink="true">×</button>`;
                cartList.appendChild(drinkItem);
            }
            updateTotalPrice();
            updateMenuSelection();
        }

        function updateTotalPrice() {
            let total = 0;
            cart.forEach(item => {
                const itemDetails = itemDataMap.get(item.id);
                if(itemDetails) total += parsePrice(itemDetails.price);
            });
            if (selectedDrink) {
                const drinkDetails = itemDataMap.get(selectedDrink.name);
                if (drinkDetails) total += parsePrice(drinkDetails.price);
            }
            totalPriceSpan.textContent = formatPrice(total);
        }

        function createItemButton(item) {
            itemDataMap.set(item.id || item.name, item);
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'item-button';
            button.dataset.id = item.id || item.name;
            button.dataset.type = item.type;
            button.innerHTML = `<div class="item-details"><h4>${item.title || item.name}</h4><p>${item.description}</p><div class="price">${formatPrice(parsePrice(item.price))}</div></div>`;
            return button;
        }

        function handleSelection(e) {
            const itemButton = e.target.closest('.item-button');
            if (!itemButton) return;
            const id = itemButton.dataset.id;
            const type = itemButton.dataset.type;

            if (type === 'speise') {
                const existingIndex = cart.findIndex(item => item.id === id);
                if (existingIndex > -1) {
                    cart.splice(existingIndex, 1);
                } else {
                    cart.push({ id: id, variants: [], dips: [] });
                }
            } else if (type === 'getraenk') {
                if (selectedDrink && selectedDrink.name === id) {
                    selectedDrink = null;
                } else {
                    selectedDrink = { name: id };
                }
            }
            renderCart();
        }

        function setupScrollAnimations(container) {
            const itemsToAnimate = container.querySelectorAll('.item-button');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        entry.target.style.transitionDelay = `${index * 50}ms`;
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            itemsToAnimate.forEach(item => observer.observe(item));
        }
        
        function loadOrderForEditing() {
            formTitle.textContent = "Bestellung bearbeiten";
            submitButton.textContent = "Änderungen speichern";
            fetch(`http://localhost:8080/api/lists/${listId}/orders/${orderIdToEdit}`)
                .then(res => {
                    if (!res.ok) throw new Error("Bestellung nicht gefunden");
                    return res.json();
                })
                .then(order => {
                    creatorNameInput.value = order.creator;
                    cart = order.store_items || [];
                    selectedDrink = order.drink || null;
                    renderCart();
                });
        }

        function saveOrderToHistory(orderPayload) {
            let history = JSON.parse(localStorage.getItem('orderHistory')) || [];
            history.unshift(orderPayload);
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('orderHistory', JSON.stringify(history));
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
            historyList.innerHTML = '';
            historyPlaceholder.style.display = history.length === 0 ? 'block' : 'none';
            history.forEach((order, index) => {
                const firstFoodItem = itemDataMap.get(order.store_items[0]?.id);
                const foodName = firstFoodItem ? firstFoodItem.title : "Unbekannte Speise";
                const drinkName = order.drink ? order.drink.name : "Kein Getränk";
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.historyIndex = index;
                historyItem.innerHTML = `<div class="food">${foodName} ${order.store_items.length > 1 ? `(+${order.store_items.length - 1})` : ''}</div><div class="drink">${drinkName}</div>`;
                historyList.appendChild(historyItem);
            });
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
            const orderToLoad = history[index];
            if (!orderToLoad) return;
            cart = orderToLoad.store_items || [];
            selectedDrink = orderToLoad.drink || null;
            renderCart();
        }
        
        cartList.addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('cart-item-remove')) {
                if (target.dataset.drink) {
                    selectedDrink = null;
                } else {
                    const index = parseInt(target.dataset.cartIndex, 10);
                    cart.splice(index, 1);
                }
                renderCart();
            }
        });

        historyList.addEventListener('click', (e) => {
            const historyItem = e.target.closest('.history-item');
            if (historyItem) loadFromHistory(historyItem.dataset.historyIndex);
        });

        orderForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const creator = creatorNameInput.value.trim();
            if (!creator || cart.length === 0) {
                formError.style.display = 'block';
                return;
            }
            formError.style.display = 'none';

            const orderPayload = {
                creator: creator,
                store_items: cart,
            };
            if (selectedDrink) orderPayload.drink = selectedDrink;
            
            let url = `http://localhost:8080/api/lists/${listId}/orders`;
            let method = 'POST';

            if (orderIdToEdit) {
                url = `http://localhost:8080/api/lists/${listId}/orders/${orderIdToEdit}`;
                method = 'PUT';
                const myOrderKeys = JSON.parse(localStorage.getItem('myOrderKeys')) || {};
                orderPayload.editKey = myOrderKeys[orderIdToEdit];
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderPayload)
            })
            .then(response => { if (!response.ok) throw new Error('Aktion fehlgeschlagen'); return response.json(); })
            .then(data => {
                if (method === 'POST') {
                    saveOrderToHistory(orderPayload);
                    let myOrderKeys = JSON.parse(localStorage.getItem('myOrderKeys')) || {};
                    myOrderKeys[data.id] = data.editKey;
                    localStorage.setItem('myOrderKeys', JSON.stringify(myOrderKeys));
                }
                window.location.href = `checkout.html?id=${listId}`;
            })
            .catch(error => alert('Fehler: ' + error.message));
        });
        
        // --- INITIALISIERUNG ---
        loadAndCheckDeadline();
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                data.categories?.forEach(cat => cat.items?.forEach(item => { item.type = 'speise'; allSpeisen.push(item); }));
                data.drinks?.forEach(drink => { drink.type = 'getraenk'; allGetraenke.push(drink); });
                
                allSpeisen.forEach(item => itemDataMap.set(item.id, item));
                allGetraenke.forEach(item => itemDataMap.set(item.name, item));
                
                renderItems();
                renderHistory();
                if (orderIdToEdit) {
                    loadOrderForEditing();
                }
            });
        setupSortDropdowns();
        speisenList.addEventListener('click', handleSelection);
        getraenkeList.addEventListener('click', handleSelection);
    });
</script>
</body>
</html>