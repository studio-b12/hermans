<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung aufgeben</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <form id="orderForm">
            <div class="menu-wrapper">
                <div class="category-card">
                    <div class="category-header"><h2 class="category-title">Speisen</h2></div>
                    <input type="search" class="search-input" data-controls="speisen-list" placeholder="Speisen durchsuchen...">
                    <div class="items-list" id="speisen-list"></div>
                </div>

                <div class="category-card">
                    <div class="category-header"><h2 class="category-title">Getränke</h2></div>
                    <input type="search" class="search-input" data-controls="getraenke-list" placeholder="Getränke durchsuchen...">
                    <div class="items-list" id="getraenke-list"></div>
                </div>
            </div>

            <div class="submission-card">
                <h3>Dein Name</h3>
                <input type="text" id="creatorName" placeholder="Max Mustermann" required>
                <div class="total-price">Gesamt: <span id="totalPriceSpan">0,00 €</span></div>
                <button type="submit" class="btn">Bestellung abschicken</button>
                <p id="formError" style="color:red;display:none;margin-top:10px;">Bitte wähle mindestens eine Speise und gib deinen Namen ein.</p>
            </div>
        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const speisenList = document.getElementById('speisen-list');
            const getraenkeList = document.getElementById('getraenke-list');
            const orderForm = document.getElementById('orderForm');
            const totalPriceSpan = document.getElementById('totalPriceSpan');
            const creatorNameInput = document.getElementById('creatorName');
            const formError = document.getElementById('formError');

            const apiUrl = '/api/items';
            const params = new URLSearchParams(window.location.search);
            const listId = params.get('id');
            
            const itemDataMap = new Map();
            let selection = {
                storeItemId: null,
                variants: new Set(),
                dips: new Set(),
                drinkName: null,
            };

            function parsePrice(priceValue) {
                if (typeof priceValue !== 'string') return 0;
                const cleanedString = priceValue.replace(/[^0-9,-]/g, '').replace(',', '.').trim();
                const price = parseFloat(cleanedString);
                return isNaN(price) ? 0 : price;
            }

            function parseExtraPrice(text) {
                if (typeof text !== 'string') return 0;
                const match = text.match(/\(\+?\s*([0-9,]+)\s*€\)/);
                if (match && match[1]) {
                    return parsePrice(match[1]);
                }
                return 0;
            }

            const formatPrice = (price) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(price);
            
            function updateTotalPrice() {
                let total = 0;
                if (selection.storeItemId) {
                    const item = itemDataMap.get(selection.storeItemId);
                    if (!item) return;

                    total += parsePrice(item.price);
                    selection.variants.forEach(variantName => {
                        const variant = item.variants?.find(v => v.name === variantName);
                        if (variant) total += parseExtraPrice(variant.description);
                    });
                    selection.dips.forEach(dipText => {
                        total += parseExtraPrice(dipText);
                    });
                }
                if (selection.drinkName) {
                    const drink = itemDataMap.get(selection.drinkName);
                    if (drink) total += parsePrice(drink.price);
                }
                totalPriceSpan.textContent = formatPrice(total);
            }
            
            function renderOptionButtons(title, options, groupName) {
                if (!options || options.length === 0) return '';
                return `<div class="options-group"><h5>${title}</h5><div class="options-grid">${
                    options.map(option => {
                        const isString = typeof option === 'string';
                        const value = isString ? option : option.name;
                        const text = isString ? option : option.description;
                        return `<button type="button" class="option-button" data-type="${groupName}" data-value="${value}">${text}</button>`;
                    }).join('')
                }</div></div>`;
            }
            
            function createItemButton(item, type) {
                itemDataMap.set(item.id || item.name, item);
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'item-button';
                button.dataset.id = item.id || item.name;
                button.dataset.type = type;

                let optionsHTML = '';
                if (type === 'speise') {
                    optionsHTML = `<div class="item-options">
                        ${renderOptionButtons('Varianten', item.variants, 'variant')}
                        ${renderOptionButtons('Dips', item.dips, 'dip')}
                    </div>`;
                }

                button.innerHTML = `
                    <div class="item-details">
                        <h4>${item.title || item.name}</h4>
                        <p>${item.description}</p>
                        <div class="price">${item.price}</div>
                    </div>
                    ${optionsHTML}`;
                return button;
            }

            function handleSelection(e) {
                const target = e.target;
                const itemButton = target.closest('.item-button');
                if (!itemButton) return;
                
                const id = itemButton.dataset.id;
                const type = itemButton.dataset.type;
                const isMainButtonClick = target.closest('.item-details');

                if (isMainButtonClick) {
                    const listContainer = type === 'speise' ? speisenList : getraenkeList;
                    const currentlySelected = listContainer.querySelector('.item-button.selected');
                    if (currentlySelected && currentlySelected !== itemButton) {
                        currentlySelected.classList.remove('selected', 'expanded');
                    }
                    itemButton.classList.toggle('selected');
                    itemButton.classList.toggle('expanded', itemButton.classList.contains('selected'));
                    if (type === 'speise') {
                        selection.storeItemId = itemButton.classList.contains('selected') ? id : null;
                        selection.variants.clear();
                        selection.dips.clear();
                    } else {
                        selection.drinkName = itemButton.classList.contains('selected') ? id : null;
                    }
                }

                const optionButton = target.closest('.option-button');
                if (optionButton) {
                    const optionType = optionButton.dataset.type;
                    const value = optionButton.dataset.value;
                    if (optionType === 'variant' || optionType === 'dip') {
                        optionButton.classList.toggle('selected');
                        const set = optionType === 'variant' ? selection.variants : selection.dips;
                        if (set.has(value)) set.delete(value); else set.add(value);
                    }
                }
                updateTotalPrice();
            }

            speisenList.addEventListener('click', handleSelection);
            getraenkeList.addEventListener('click', handleSelection);
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    data.categories?.forEach(cat => cat.items?.forEach(item => speisenList.appendChild(createItemButton(item, 'speise'))));
                    data.drinks?.forEach(drink => getraenkeList.appendChild(createItemButton(drink, 'getraenk')));
                    setupScrollAnimations(speisenList);
                    setupScrollAnimations(getraenkeList);
                });
                
            document.querySelectorAll('.search-input').forEach(input => {
                input.addEventListener('input', e => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const listId = e.target.dataset.controls;
                    document.getElementById(listId).querySelectorAll('.item-button').forEach(item => {
                        item.style.display = item.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                });
            });

            function setupScrollAnimations(container) {
                const itemsToAnimate = container.querySelectorAll('.item-button');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry, index) => {
                        if (entry.isIntersecting) {
                            entry.target.style.transitionDelay = `${index * 50}ms`;
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                itemsToAnimate.forEach(item => observer.observe(item));
            }

            orderForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const creator = creatorNameInput.value.trim();
                if (!creator || !selection.storeItemId) {
                    formError.style.display = 'block';
                    return;
                }
                formError.style.display = 'none';

                const orderPayload = {
                    creator: creator,
                    store_item: { id: selection.storeItemId, variants: Array.from(selection.variants), dips: Array.from(selection.dips) }
                };
                
                if (selection.drinkName) {
                    orderPayload.drink = { name: selection.drinkName };
                }

                fetch(`/api/lists/${listId}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderPayload)
                })
                .then(response => { if (!response.ok) throw new Error('Bestellung fehlgeschlagen'); return response.json(); })
                .then(() => {
                    window.location.href = `checkout.html?id=${listId}`;
                })
                .catch(error => alert('Fehler beim Bestellen: ' + error.message));
            });
        });
    </script>
</body>
</html>