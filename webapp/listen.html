<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellübersicht</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="list-header">
            <h2>Bestellübersicht</h2>
            <div id="listInfo"><p>Lade Listen-Details...</p></div>
        </div>
        
        <div class="page-content">
            <div class="summary-grid">
                <div class="summary-container" id="foodSummaryContainer">
                    <h3>Speisen-Zusammenfassung</h3>
                    <div id="summaryList"></div>
                </div>
                <div class="summary-container" id="drinkSummaryContainer">
                    <h3>Getränke-Zusammenfassung</h3>
                    <div id="drinkSummaryList"></div>
                </div>
            </div>

            <details class="details-accordion" id="detailsAccordion" style="display: none;">
                <summary>Alle einzelnen Bestellungen anzeigen</summary>
                <div class="orders-container" id="ordersContainer"></div>
            </details>
        </div>
    </div>
    <script>
        const listInfoDiv = document.getElementById('listInfo');
        const ordersContainer = document.getElementById('ordersContainer');
        const summaryListDiv = document.getElementById('summaryList');
        const drinkSummaryListDiv = document.getElementById('drinkSummaryList');
        const detailsAccordion = document.getElementById('detailsAccordion');
        const params = new URLSearchParams(window.location.search);
        const listId = params.get('id');

        function setupScrollAnimations(container) {
            const itemsToAnimate = container.querySelectorAll('.summary-card, .order-card');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        entry.target.style.transitionDelay = `${index * 50}ms`;
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            itemsToAnimate.forEach(item => observer.observe(item));
        }

        function loadAndRenderList() {
            if (!listId) {
                ordersContainer.innerHTML = "<p style='color:red;'>Fehler: Keine Listen-ID in der URL gefunden.</p>";
                return;
            }

            const listUrl = `/api/lists/${listId}`;
            const itemsUrl = '/api/items';

            Promise.all([
                fetch(listUrl).then(res => res.json()),
                fetch(itemsUrl).then(res => res.json())
            ])
            .then(([listData, itemsData]) => {
                
                const allItemsMap = new Map();
                if (itemsData?.categories) {
                    itemsData.categories.forEach(cat => cat.items?.forEach(item => allItemsMap.set(item.id, item)));
                }
                if (itemsData?.drinks) {
                    itemsData.drinks.forEach(drink => allItemsMap.set(drink.name, drink));
                }

                const createdDate = new Date(listData.created);
                listInfoDiv.innerHTML = `
                    <p style="margin:0; color: var(--text-light);">
                        <strong>ID:</strong> ${listData.id} | 
                        <strong>Erstellt:</strong> ${createdDate.toLocaleDateString('de-DE')}
                    </p>
                `;

                ordersContainer.innerHTML = '';
                summaryListDiv.innerHTML = '';
                drinkSummaryListDiv.innerHTML = '';
                
                if (Array.isArray(listData.orders) && listData.orders.length > 0) {
                    detailsAccordion.style.display = 'block';
                    
                    const foodSummary = new Map();
                    const drinkSummary = new Map();

                    listData.orders.forEach(order => {
                        const variants = (order.store_item.variants || []).sort().join(',');
                        const dips = (order.store_item.dips || []).sort().join(',');
                        const drinkNameForFoodKey = order.drink ? order.drink.name : 'kein-getraenk';
                        const foodKey = `${order.store_item.id}|${variants}|${dips}|${drinkNameForFoodKey}`;
                        
                        if (foodSummary.has(foodKey)) {
                            foodSummary.get(foodKey).count++;
                            foodSummary.get(foodKey).creators.push(order.creator);
                        } else {
                            foodSummary.set(foodKey, { count: 1, creators: [order.creator], orderDetails: order });
                        }

                        if (order.drink && order.drink.name) {
                            const drinkName = order.drink.name;
                            drinkSummary.set(drinkName, (drinkSummary.get(drinkName) || 0) + 1);
                        }
                    });

                    foodSummary.forEach(summary => {
                        const order = summary.orderDetails;
                        const itemDetails = allItemsMap.get(order.store_item.id);
                        const itemName = itemDetails ? itemDetails.title : `ID: ${order.store_item.id}`;
                        let drinkHtml = '<span class="name">-</span>';
                        if (order.drink) { drinkHtml = `<span class="name">${order.drink.name}</span>`; }
                        let extrasHtml = '';
                        const variants = order.store_item.variants || [];
                        const dips = order.store_item.dips || [];
                        if (variants.length > 0 || dips.length > 0) {
                            extrasHtml = '<ul class="order-extras-list">';
                            variants.forEach(v => extrasHtml += `<li>${v}</li>`);
                            dips.forEach(d => extrasHtml += `<li>${d}</li>`);
                            extrasHtml += '</ul>';
                        }
                        const summaryCard = document.createElement('div');
                        summaryCard.className = 'summary-card';
                        summaryCard.innerHTML = `
                            <div class="summary-header">
                                <div class="summary-count">${summary.count}x</div>
                                <strong>${itemName}</strong>
                            </div>
                            <div class="order-body">
                                ${extrasHtml ? `<div class="order-item">${extrasHtml}</div>` : ''}
                                <div class="order-item"><span class="type">Getränk:</span> ${drinkHtml}</div>
                                <div class="order-item"><span class="type">Bestellt von:</span> <span class="name">${summary.creators.join(', ')}</span></div>
                            </div>
                        `;
                        summaryListDiv.appendChild(summaryCard);
                    });

                    if (drinkSummary.size > 0) {
                        drinkSummary.forEach((count, name) => {
                            const drinkItemDiv = document.createElement('div');
                            drinkItemDiv.className = 'drink-summary-item';
                            drinkItemDiv.innerHTML = `
                                <span class="name">${name}</span>
                                <span class="count">${count}x</span>
                            `;
                            drinkSummaryListDiv.appendChild(drinkItemDiv);
                        });
                    } else {
                        drinkSummaryListDiv.innerHTML = "<p>Keine Getränke bestellt.</p>";
                    }

                    listData.orders.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'order-card';
                        const orderDate = new Date(order.created);
                        const itemDetails = allItemsMap.get(order.store_item.id);
                        const itemName = itemDetails ? itemDetails.title : `ID: ${order.store_item.id}`;
                        let drinkHtml = '<span class="name">-</span>';
                        if (order.drink) { drinkHtml = `<span class="name">${order.drink.name}</span>`; }
                        let extrasHtml = '';
                        const variants = order.store_item.variants || [];
                        const dips = order.store_item.dips || [];
                        if (variants.length > 0 || dips.length > 0) {
                            extrasHtml = '<ul class="order-extras-list">';
                            variants.forEach(v => extrasHtml += `<li>${v}</li>`);
                            dips.forEach(d => extrasHtml += `<li>${d}</li>`);
                            extrasHtml += '</ul>';
                        }
                        orderCard.innerHTML = `
                            <div class="order-header">
                                <strong>${order.creator}</strong>
                                <span class="timestamp">${orderDate.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})} Uhr</span>
                            </div>
                            <div class="order-body">
                                <div class="order-item"><span class="type">Speise:</span> <span class="name">${itemName}</span>${extrasHtml}</div>
                                <div class="order-item"><span class="type">Getränk:</span> ${drinkHtml}</div>
                            </div>
                        `;
                        ordersContainer.appendChild(orderCard);
                    });
                    
                    setupScrollAnimations(summaryListDiv);
                    setupScrollAnimations(ordersContainer);

                } else {
                    summaryListDiv.innerHTML = "<p>Noch keine Bestellungen vorhanden.</p>";
                    drinkSummaryListDiv.innerHTML = "";
                    detailsAccordion.style.display = 'none';
                }
            })
            .catch(err => { console.error("Fehler:", err); });
        }
        
        loadAndRenderList();
        setInterval(loadAndRenderList, 600000);
    </script>
</body>
</html>